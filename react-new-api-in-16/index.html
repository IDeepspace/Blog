<!DOCTYPE HTML><html lang="zh-CN"><head><head><meta name="generator" content="Hexo 3.8.0"><meta charset="utf-8"><meta name="keywords" content="React 16 中的新特性, Deepspace"><meta name="description" content="
对于 React v16 之后版本中的一些新特性，挑选了以下几个常用的 Api 来讲解 :

Render 方法优化
错误边界
Portals
Context API
新的生命周期

后面会持续更新。
一、Render 方法优化为了符合 "><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><meta name="renderer" content="webkit|ie-stand|ie-comp"><meta name="mobile-web-app-capable" content="yes"><meta name="format-detection" content="telephone=no"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"><title>React 16 中的新特性 | Deepspace</title><link rel="icon" type="image/png" href="/favicon.png"><link rel="stylesheet" type="text/css" href="/libs/awesome/css/font-awesome.min.css"><link rel="stylesheet" type="text/css" href="/libs/materialize/css/materialize.min.css"><link rel="stylesheet" type="text/css" href="/libs/aos/aos.css"><link rel="stylesheet" type="text/css" href="/libs/animate/animate.min.css"><link rel="stylesheet" type="text/css" href="/libs/lightGallery/css/lightgallery.min.css"><link rel="stylesheet" type="text/css" href="/css/matery.css"><link rel="stylesheet" type="text/css" href="/css/my.css"><script src="/libs/jquery/jquery-2.2.0.min.js"></script><link rel="stylesheet" href="/css/prism-tomorrow.css" type="text/css"></head></head><body><header class="navbar-fixed"><nav id="headNav" class="bg-color nav-transparent"><div id="navContainer" class="container"><div class="nav-wrapper"><div class="brand-logo"><a href="/" class="waves-effect waves-light"><span></span> <span class="logo-span">Deepspace</span></a></div><a href="#" data-activates="mobile-nav" class="button-collapse"><i class="fa fa-navicon"></i></a><ul class="right"><li class="hide-on-med-and-down"><a href="/" class="waves-effect waves-light"><i class="fa fa-home"></i> <span>首页</span></a></li><li class="hide-on-med-and-down"><a href="/tags" class="waves-effect waves-light"><i class="fa fa-tags"></i> <span>标签</span></a></li><li class="hide-on-med-and-down"><a href="/categories" class="waves-effect waves-light"><i class="fa fa-bookmark"></i> <span>分类</span></a></li><li class="hide-on-med-and-down"><a href="/archives" class="waves-effect waves-light"><i class="fa fa-archive"></i> <span>归档</span></a></li><li class="hide-on-med-and-down"><a href="/about" class="waves-effect waves-light"><i class="fa fa-user-circle-o"></i> <span>关于</span></a></li><li><a id="toggleSearch" class="waves-effect waves-light"><i id="searchIcon" class="mdi-action-search"></i></a></li></ul><div class="side-nav" id="mobile-nav"><div class="mobile-head bg-color"><div class="logo-name">Deepspace</div><div class="logo-desc"> 凡事预 ？立 ：废</div></div><ul class="menu-list mobile-menu-list"><li><a href="/" class="waves-effect waves-light"><i class="fa fa-fw fa-home"></i> 首页</a></li><li><a href="/tags" class="waves-effect waves-light"><i class="fa fa-fw fa-tags"></i> 标签</a></li><li><a href="/categories" class="waves-effect waves-light"><i class="fa fa-fw fa-bookmark"></i> 分类</a></li><li><a href="/archives" class="waves-effect waves-light"><i class="fa fa-fw fa-archive"></i> 归档</a></li><li><a href="/about" class="waves-effect waves-light"><i class="fa fa-fw fa-user-circle-o"></i> 关于</a></li><li><div class="divider"></div></li><li><a href="https://github.com/IDeepspace" class="waves-effect waves-light" target="_blank"><i class="fa fa-github-square fa-fw"></i> Fork Me</a></li></ul><div class="social-link"><a href="https://github.com/IDeepspace" class="tooltipped" target="_blank" data-tooltip="访问我的GitHub" data-position="top" data-delay="50"><i class="fa fa-github"></i></a><a href="mailto:cxin1427@qq.com" class="tooltipped" target="_blank" data-tooltip="邮件联系我" data-position="top" data-delay="50"><i class="fa fa-envelope-open"></i></a><a href="#!" class="tooltipped" data-tooltip="QQ: 690862036" data-position="top" data-delay="50"><i class="fa fa-qq"></i></a><a href="/atom.xml" class="tooltipped" target="_blank" data-tooltip="RSS 订阅" data-position="top" data-delay="50"><i class="fa fa-rss"></i></a></div></div></div></div><style>.nav-transparent .github-corner{display:none!important}.github-corner{position:absolute;z-index:10;top:0;right:0;border:0;transform:scale(1.1)}.github-corner svg{color:#202020;fill:#fff;height:64px;width:64px}.github-corner:hover .octo-arm{animation:a .56s ease-in-out}.github-corner .octo-arm{animation:none}@keyframes a{0%,to{transform:rotate(0)}20%,60%{transform:rotate(-25deg)}40%,80%{transform:rotate(10deg)}}</style> <a href="https://github.com/IDeepspace" class="github-corner tooltipped hide-on-med-and-down" target="_blank" data-tooltip="Fork Me" data-position="left" data-delay="50"><svg viewbox="0 0 250 250" aria-hidden="true"><path d="M0 0 115 115 130 115 142 142 250 250 250 0Z"/><path d="M128.3 109C113.8 99.7 119 89.6 119 89.6 122 82.7 120.5 78.6 120.5 78.6 119.2 72 123.4 76.3 123.4 76.3 127.3 80.9 125.5 87.3 125.5 87.3 122.9 97.6 130.6 101.9 134.4 103.2" fill="currentColor" style="transform-origin:130px 106px" class="octo-arm"/><path d="M115 115C114.9 115.1 118.7 116.5 119.8 115.4L133.7 101.6C136.9 99.2 139.9 98.4 142.2 98.6 133.8 88 127.5 74.4 143.8 58 148.5 53.4 154 51.2 159.7 51 160.3 49.4 163.2 43.6 171.4 40.1 171.4 40.1 176.1 42.5 178.8 56.2 183.1 58.6 187.2 61.8 190.9 65.4 194.5 69 197.7 73.2 200.1 77.6 213.8 80.2 216.3 84.9 216.3 84.9 212.7 93.1 206.9 96 205.4 96.6 205.1 102.4 203 107.8 198.3 112.5 181.9 128.9 168.3 122.5 157.7 114.1 157.9 116.9 156.7 120.9 152.7 124.9L141 136.5C139.8 137.7 141.6 141.9 141.8 141.8Z" fill="currentColor" class="octo-body"/></svg></a></nav></header><div class="bg-cover post-cover" style="background-image:url(/medias/featureimages/lighted.jpg)"><div class="container"><div class="row"><div class="col s12 m12 l12"><div class="brand"><div class="description center-align post-detail-title"> React 16 中的新特性</div></div></div></div></div></div><main class="post-container content"><link rel="stylesheet" href="/libs/tocbot/tocbot.css"><style>#articleContent h1,#articleContent h2,#articleContent h3,#articleContent h4,#articleContent h5,#articleContent h6{padding-top:76px;margin-top:-76px}#articleContent h1{line-height:3.5rem}#articleContent h2{line-height:3.2rem}#articleContent h3{line-height:2.8rem}#articleContent h4{line-height:2.5rem}#articleContent h5{line-height:2.2rem}#articleContent h6{line-height:1.9rem}#articleContent :focus{outline:0}.toc-fixed{position:fixed;top:64px}.toc-widget{padding-left:20px}.toc-widget .toc-title{margin:35px 0 15px 0;padding-left:17px;font-size:1.5rem;font-weight:700;line-height:1.5rem}.toc-widget ol{padding:0;list-style:none}#toc-content ol{padding-left:10px}#toc-content ol li{padding-left:10px}#toc-content .toc-link:hover{color:#42b983;font-weight:700;text-decoration:underline}#toc-content .toc-link::before{background-color:transparent;max-height:25px}#toc-content .is-active-link{color:#42b983}#toc-content .is-active-link::before{background-color:#42b983}</style><div class="row"><div class="col s12 m12 l9"><div id="artDetail"><div class="card"><div class="card-content article-info"><div class="article-tag"> <a href="/tags/React/" target="_blank"><span class="chip bg-color">React</span></a> <a href="/tags/Portals/" target="_blank"><span class="chip bg-color">Portals</span></a> <a href="/tags/ErrorBoundary/" target="_blank"><span class="chip bg-color">ErrorBoundary</span></a></div><div class="post-info"><span class="post-cate"><i class="fa fa-bookmark fa-fw icon-category"></i> <a href="/categories/React/" class="post-category" target="_blank">React</a></span><span class="post-date"><i class="fa fa-clock-o fa-fw"></i> 2019-03-23</span></div></div><hr><div class="card-content article-card-content"><div id="articleContent"> <p>对于 <code>React v16</code> 之后版本中的一些新特性，挑选了以下几个常用的 <code>Api</code> 来讲解 :</p><ul><li><code>Render</code> 方法优化</li><li>错误边界</li><li><code>Portals</code></li><li><code>Context API</code></li><li>新的生命周期</li></ul><p>后面会持续更新。</p><h3 id="一、Render-方法优化"><a href="#一、Render-方法优化" class="headerlink" title="一、Render 方法优化"></a>一、Render 方法优化</h3><p>为了符合 <code>React</code> 的 <code>component tree</code> 和 <code>diff</code> 结构设计，在组件的 <code>render</code> 方法中，顶层必须包裹为单节点，因此我们在实际组件的设计和使用中，需要注意尽量避免嵌套后的层级变深。<br><a id="more"></a><br>比如下面的内容结构就必须再嵌套一个 <code>div</code> 使其变成单节点再返回：</p><pre class="language-jsx"><code class="language-jsx"><span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">></span></span>one<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">></span></span>two<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">></span></span>three<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><p><code>React v16</code> 之后，这个问题得到了改进，<code>render</code> 方法支持返回数组和字符串了:</p><pre class="language-jsx"><code class="language-jsx"><span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> data <span class="token operator">=</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span> value<span class="token punctuation">:</span> <span class="token string">'One'</span><span class="token punctuation">,</span> key<span class="token punctuation">:</span> <span class="token string">'1'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span> value<span class="token punctuation">:</span> <span class="token string">'Two'</span><span class="token punctuation">,</span> key<span class="token punctuation">:</span> <span class="token string">'2'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span> value<span class="token punctuation">:</span> <span class="token string">'Three'</span><span class="token punctuation">,</span> key<span class="token punctuation">:</span> <span class="token string">'3'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> data<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>item <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// Don't forget the keys :)</span>
    <span class="token keyword">return</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span> <span class="token attr-name">key</span><span class="token script language-javascript"><span class="token punctuation">=</span><span class="token punctuation">{</span>item<span class="token punctuation">.</span>key<span class="token punctuation">}</span></span><span class="token punctuation">></span></span><span class="token punctuation">{</span>item<span class="token punctuation">.</span>value<span class="token punctuation">}</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">></span></span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><p>支持返回数组之后，有时候我们的代码可能长成下面这个样子：</p><pre class="language-jsx"><code class="language-jsx"><span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token keyword">return</span> <span class="token punctuation">[</span>
     <span class="token string">"Some text."</span><span class="token punctuation">,</span>
     <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h2</span> <span class="token attr-name">key</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>heading-1<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>A heading<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h2</span><span class="token punctuation">></span></span><span class="token punctuation">,</span>
     <span class="token string">"More text."</span><span class="token punctuation">,</span>
     <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h2</span> <span class="token attr-name">key</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>heading-2<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>Another heading<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h2</span><span class="token punctuation">></span></span><span class="token punctuation">,</span>
     <span class="token string">"Even more text."</span>
   <span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><p>虽然减少了一层嵌套，但是代码看上去不简洁：</p><ul><li>数组中的元素必须以逗号分隔；</li><li>数组中的子节点都必须添加一个 <code>key</code> 属性来避免 <code>React</code> 的警告；</li><li>字符串必须用引号括起来。</li></ul><p>所以，在 <code>React v16.2</code> 中，官方又推出了 <code>Fragment</code> 组件来代替直接 <code>render</code> 数组的方式：</p><pre class="language-jsx"><code class="language-jsx"><span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Fragment</span><span class="token punctuation">></span></span>
      Some text<span class="token punctuation">.</span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h2</span><span class="token punctuation">></span></span>A heading<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h2</span><span class="token punctuation">></span></span>
      More text<span class="token punctuation">.</span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h2</span><span class="token punctuation">></span></span>Another heading<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h2</span><span class="token punctuation">></span></span>
      Even more text<span class="token punctuation">.</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Fragment</span><span class="token punctuation">></span></span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><p><code>Fragment</code> 虽然也是一个正常单节点写法，直接包裹里面的内容。但是 <code>Fragment</code> 本身并不会产生真实的 <code>DOM</code> 节点，因此也不会导致层级嵌套增加。<code>Fragment</code> 组件也提供了简写的方式：</p><pre class="language-jsx"><code class="language-jsx"><span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span>
    <span class="token operator">&lt;</span><span class="token operator">></span>
      Some text<span class="token punctuation">.</span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h2</span><span class="token punctuation">></span></span>A heading<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h2</span><span class="token punctuation">></span></span>
      More text<span class="token punctuation">.</span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h2</span><span class="token punctuation">></span></span>Another heading<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h2</span><span class="token punctuation">></span></span>
      Even more text<span class="token punctuation">.</span>
    <span class="token operator">&lt;</span><span class="token operator">/</span><span class="token operator">></span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><p>如果需要给 <code>Fragment</code> 添加 <code>key</code> 属性，是不支持使用简写的。（这也是 <code>Fragment</code> 唯一会遇到需要添加 <code>props</code> 的情况：</p><pre class="language-jsx"><code class="language-jsx"><span class="token keyword">function</span> <span class="token function">Glossary</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dl</span><span class="token punctuation">></span></span>
      <span class="token punctuation">{</span>props<span class="token punctuation">.</span>items<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>item <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">(</span>
        <span class="token comment" spellcheck="true">// Without the `key`, React will fire a key warning</span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Fragment</span> <span class="token attr-name">key</span><span class="token script language-javascript"><span class="token punctuation">=</span><span class="token punctuation">{</span>item<span class="token punctuation">.</span>id<span class="token punctuation">}</span></span><span class="token punctuation">></span></span>
          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dt</span><span class="token punctuation">></span></span><span class="token punctuation">{</span>item<span class="token punctuation">.</span>term<span class="token punctuation">}</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dt</span><span class="token punctuation">></span></span>
          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dd</span><span class="token punctuation">></span></span><span class="token punctuation">{</span>item<span class="token punctuation">.</span>description<span class="token punctuation">}</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dd</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Fragment</span><span class="token punctuation">></span></span>
      <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">}</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dl</span><span class="token punctuation">></span></span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><h3 id="二、错误边界"><a href="#二、错误边界" class="headerlink" title="二、错误边界"></a>二、错误边界</h3><p><code>UI</code> 部分的一个 <code>JavaScript</code> 错误不应该破坏整个程序。为了解决这个问题，<code>React v16</code> 引入了<strong>错误边界</strong>的新概念。</p><p>错误边界是<strong>用于捕获其子组件树 <code>JavaScript</code> 异常，记录错误并展示一个回退的 UI</strong> 的 <code>React</code> 组件，而不是整个组件树的异常。错误边界在渲染期间、生命周期方法内、以及整个组件树构造函数内捕获错误。</p><p>下面的例子是通过一个 <code>ErrorBoundary</code> 组件对其内的内容进行保护和错误捕捉，并在发生错误时进行回退的UI展示：</p><pre class="language-jsx"><code class="language-jsx"><span class="token keyword">class</span> <span class="token class-name">ErrorBoundary</span> <span class="token keyword">extends</span> <span class="token class-name">Component</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">super</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">=</span> <span class="token punctuation">{</span> error<span class="token punctuation">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span> errorInfo<span class="token punctuation">:</span> <span class="token keyword">null</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">componentDidCatch</span><span class="token punctuation">(</span>error<span class="token punctuation">,</span> errorInfo<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// Catch errors in any components below and re-render with error message</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      error<span class="token punctuation">:</span> error<span class="token punctuation">,</span>
      errorInfo<span class="token punctuation">:</span> errorInfo<span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">// You can also log error messages to an error reporting service here</span>
  <span class="token punctuation">}</span>

  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>errorInfo<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment" spellcheck="true">// Error path</span>
      <span class="token keyword">return</span> <span class="token punctuation">(</span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">></span></span>
          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h2</span><span class="token punctuation">></span></span>Something went wrong<span class="token punctuation">.</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h2</span><span class="token punctuation">></span></span>
          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>details</span> <span class="token attr-name">style</span><span class="token script language-javascript"><span class="token punctuation">=</span><span class="token punctuation">{</span><span class="token punctuation">{</span> whiteSpace<span class="token punctuation">:</span> <span class="token string">'pre-wrap'</span> <span class="token punctuation">}</span><span class="token punctuation">}</span></span><span class="token punctuation">></span></span>
            <span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>error <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>error<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span> <span class="token punctuation">/></span></span>
            <span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>errorInfo<span class="token punctuation">.</span>componentStack<span class="token punctuation">}</span>
          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>details</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment" spellcheck="true">// Normally, just render children</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">.</span>children<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><p>然后我们就可以像一个普通的组件一样使用：</p><pre class="language-jsx"><code class="language-jsx"><span class="token keyword">class</span> <span class="token class-name">BuggyCounter</span> <span class="token keyword">extends</span> <span class="token class-name">Component</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">super</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">=</span> <span class="token punctuation">{</span> counter<span class="token punctuation">:</span> <span class="token number">0</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>handleClick <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>handleClick<span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">handleClick</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">{</span> counter <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">(</span><span class="token punctuation">{</span>
      counter<span class="token punctuation">:</span> counter <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>counter <span class="token operator">===</span> <span class="token number">5</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment" spellcheck="true">// Simulate a JS error</span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'I crashed!'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h1</span> <span class="token attr-name">onClick</span><span class="token script language-javascript"><span class="token punctuation">=</span><span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>handleClick<span class="token punctuation">}</span></span><span class="token punctuation">></span></span><span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>counter<span class="token punctuation">}</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h1</span><span class="token punctuation">></span></span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">App</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ErrorBoundary</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">></span></span>
          These two counters are inside the same error boundary<span class="token punctuation">.</span> If one crashes<span class="token punctuation">,</span>
          the error boundary will replace both <span class="token keyword">of</span> them<span class="token punctuation">.</span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>BuggyCounter</span> <span class="token punctuation">/></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>BuggyCounter</span> <span class="token punctuation">/></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ErrorBoundary</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>hr</span> <span class="token punctuation">/></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">></span></span>
        These two counters are each inside <span class="token keyword">of</span> their own error boundary<span class="token punctuation">.</span> So <span class="token keyword">if</span>
        one crashes<span class="token punctuation">,</span> the other is not affected<span class="token punctuation">.</span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ErrorBoundary</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>BuggyCounter</span> <span class="token punctuation">/></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ErrorBoundary</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ErrorBoundary</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>BuggyCounter</span> <span class="token punctuation">/></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ErrorBoundary</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><p>错误边界工作机制类似于 <code>JavaScript</code> 中的 <code>catch {}</code> 。注意：仅有类组件可以成为错误边界。</p><p>在实际开发中，大多数情况下，我们可以只定义一个错误边界组件，并将它贯穿整个应用。</p><blockquote><p>注意：错误边界<strong>无法</strong>捕获如下错误:</p><ul><li>事件处理 （<a href="https://reactjs.org/docs/error-boundaries.html#how-about-event-handlers" target="_blank" rel="noopener">了解更多</a>）</li><li>异步代码 （例如 <code>setTimeout</code> 或 <code>requestAnimationFrame</code> 回调函数）</li><li>服务端渲染</li><li>错误边界自身抛出来的错误 （而不是其子组件）</li></ul></blockquote><h3 id="三、Portals"><a href="#三、Portals" class="headerlink" title="三、Portals"></a>三、Portals</h3><p><code>createPortal</code> 这个 <code>Api</code> 用于将子节点渲染到父组件以外的 <code>DOM</code> 节点上。<code>createPortal</code> 的出现为弹窗、对话框等脱离文档流的组件开发提供了很大的便利。</p><p>现在我们来想一下，如果需要显示一个对话框(<code>Dialog</code>)，该怎么做呢？</p><p>最直观的做法，就是直接在 <code>JSX</code> 中把 <code>Dialog</code> 画出来，像下面代码的样子：</p><pre class="language-jsx"><code class="language-jsx"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">></span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">></span></span> <span class="token operator">...</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>
   <span class="token punctuation">{</span> needDialog <span class="token operator">?</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Dialog</span> <span class="token punctuation">/></span></span> <span class="token punctuation">:</span> <span class="token keyword">null</span> <span class="token punctuation">}</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>
</code></pre><p>那么这样就有一个问题：这样渲染的话，<code>Dialog</code> 最终渲染产生的 <code>HTML</code> 就和上面非 <code>Dialog</code> 内容的 <code>JSX</code> 产生的<code>HTML</code> 混在一起了，像下面这样：</p><pre class="language-jsx"><code class="language-jsx"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">></span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">></span></span> <span class="token operator">...</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>dialog<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>Dialog Content<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>
</code></pre><p>而对于对话框，从用户的感知角度来说，它应该是一个独立的组件。</p><p>但是现在 <code>Dialog</code> 被包在其他组件中，那就要用 <code>CSS</code> 的 <code>position</code> 属性控制 <code>Dialog</code> 位置了，就要求从 <code>Dialog</code> 往上一直到 <code>body</code> ，没有其他 <code>position</code> 是 <code>relative</code> 的元素的干扰，显然这是比较麻烦的。同时， <code>Dialog</code> 的样式也会与其它组件混在一起。</p><p>解决这个问题，我们可以在 <code>React</code> 组件树的最顶层创建一个专属于 <code>Dialog</code> 的元素，然后通过 <code>Redux</code> 或者其他什么通讯方式给这个 <code>Dialog</code> 发送信号，来控制 <code>Dialog</code> 显示或者不显示。但是这样又会造成 “杀鸡焉用牛刀” 的问题：我们只是为了一个 <code>Dialog</code> 却引入了 <code>Redux</code> 。</p><p>在 <code>React 16</code> 之前，也有实现 “传送门” 的方式，但是官方一直并不鼓励使用，所以这里也不作深入讨论。<code>React 16</code> 后，使用 <code>createPortal Api</code> 创建 <code>Dialog</code> 组件就简单多了，不需要牵扯到 <code>componentDidMount</code>、<code>componentDidUpdate</code> 等生命周期问题，也不用调用 <code>API</code> 清理 <code>Portal</code>，关键代码在 <code>render</code> 中，我们看一下 <a href="https://codepen.io/gaearon/pen/yzMaBd" target="_blank" rel="noopener">官方给的 <code>demo</code></a> :</p><p>首先在 <code>public/index.html</code> 中新建一个根节点：</p><pre class="language-jsx"><code class="language-jsx"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>root<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>modal-root<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">></span></span>
</code></pre><p>通过 <code>createPortal Api</code> 创建一个 “传送门”：</p><pre class="language-jsx"><code class="language-jsx"><span class="token keyword">import</span> <span class="token punctuation">{</span> Component <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'react'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> ReactDOM <span class="token keyword">from</span> <span class="token string">'react-dom'</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> modalRoot <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'modal-root'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">Modal</span> <span class="token keyword">extends</span> <span class="token class-name">Component</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">super</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">// Create a div that we'll render the modal into. Because each</span>
    <span class="token comment" spellcheck="true">// Modal component has its own element, we can render multiple</span>
    <span class="token comment" spellcheck="true">// modal components into the modal container.</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>el <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'div'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">componentDidMount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// Append the element into the DOM on mount. We'll render</span>
    <span class="token comment" spellcheck="true">// into the modal container element (see the HTML tab).</span>
    modalRoot<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>el<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">componentWillUnmount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// Remove the element from the DOM when we unmount</span>
    modalRoot<span class="token punctuation">.</span><span class="token function">removeChild</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>el<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// Use a portal to render the children into the element</span>
    <span class="token keyword">return</span> ReactDOM<span class="token punctuation">.</span><span class="token function">createPortal</span><span class="token punctuation">(</span>
      <span class="token comment" spellcheck="true">// Any valid React child: JSX, strings, arrays, etc.</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">.</span>children<span class="token punctuation">,</span>
      <span class="token comment" spellcheck="true">// A DOM element</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>el<span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> Modal<span class="token punctuation">;</span>
</code></pre><p>使用 <code>Modal</code> :</p><pre class="language-jsx"><code class="language-jsx"><span class="token keyword">import</span> React<span class="token punctuation">,</span> <span class="token punctuation">{</span> Component <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'react'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> Modal <span class="token keyword">from</span> <span class="token string">'./Modal'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token string">'./style.css'</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">App</span> <span class="token keyword">extends</span> <span class="token class-name">Component</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">super</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">=</span> <span class="token punctuation">{</span> showModal<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span> clicks<span class="token punctuation">:</span> <span class="token number">0</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  handleShow <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span> showModal<span class="token punctuation">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  handleHide <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span> showModal<span class="token punctuation">:</span> <span class="token boolean">false</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  handleClick <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// This will fire when the button in Child is clicked,</span>
    <span class="token comment" spellcheck="true">// updating Parent's state, even though button</span>
    <span class="token comment" spellcheck="true">// is not direct descendant in the DOM.</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span>prevState <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">(</span><span class="token punctuation">{</span>
      clicks<span class="token punctuation">:</span> prevState<span class="token punctuation">.</span>clicks <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// Show a Modal on click.</span>
    <span class="token comment" spellcheck="true">// (In a real app, don't forget to use ARIA attributes</span>
    <span class="token comment" spellcheck="true">// for accessibility!)</span>
    <span class="token keyword">const</span> modal <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>showModal <span class="token operator">?</span> <span class="token punctuation">(</span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Modal</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">className</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">'</span>modal<span class="token punctuation">'</span></span><span class="token punctuation">></span></span>
          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">onClick</span><span class="token script language-javascript"><span class="token punctuation">=</span><span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>handleHide<span class="token punctuation">}</span></span><span class="token punctuation">></span></span>Hide modal<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">></span></span>
          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">onClick</span><span class="token script language-javascript"><span class="token punctuation">=</span><span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>handleClick<span class="token punctuation">}</span></span><span class="token punctuation">></span></span>Click<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Modal</span><span class="token punctuation">></span></span>
    <span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token punctuation">(</span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">className</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">'</span>app<span class="token punctuation">'</span></span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">></span></span>Number <span class="token keyword">of</span> clicks<span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>clicks<span class="token punctuation">}</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">></span></span>
        This div has overflow<span class="token punctuation">:</span> hidden<span class="token punctuation">.</span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">onClick</span><span class="token script language-javascript"><span class="token punctuation">=</span><span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>handleShow<span class="token punctuation">}</span></span><span class="token punctuation">></span></span>Show modal<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">></span></span>
        <span class="token punctuation">{</span>modal<span class="token punctuation">}</span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> App<span class="token punctuation">;</span>
</code></pre><p>上面的代码中，<code>App</code> 组件通过 <code>Portal</code> 把里面的内容渲染到了一个独立的节点上，在实际的 <code>DOM</code> 结构中，<code>modal</code> 里面的内容已经脱离了 <code>App</code> 组件本身的 <code>DOM</code> 树而存在于另一个独立节点。对于要通过 <code>createPortal()</code> “分离” 出去的内容，它的数据传递，生命周期，甚至事件冒泡，依然存在于原本的抽象组件树结构当中。这里实际依赖于 <code>React</code> 代理和重写了整套事件系统，让整个抽象组件树的逻辑得以保持同步。</p><p>运行上面的代码可以查看效果。</p><h3 id="四、Context-API"><a href="#四、Context-API" class="headerlink" title="四、Context API"></a>四、Context API</h3><p>参考：<a href="https://togoblog.cn/react-component-communication/#toc-heading-5">https://togoblog.cn/react-component-communication/#toc-heading-5</a></p><h3 id="五、新的生命周期"><a href="#五、新的生命周期" class="headerlink" title="五、新的生命周期"></a>五、新的生命周期</h3><h4 id="1、旧的生命周期"><a href="#1、旧的生命周期" class="headerlink" title="1、旧的生命周期"></a>1、旧的生命周期</h4><p>我们先看看 <code>React 16</code> 之前的生命周期图：</p><p><img src="https://raw.githubusercontent.com/IDeepspace/ImageHosting/master/React/react15-lifecycle.png" alt="Reactv15生命周期图" style="zoom:77%"></p><p></p><p align="center">(图片来自网络)</p><br>如上图所示，可以把组件的生命周期大致分为三个阶段：<p></p><ul><li>挂载阶段 (<code>Mount</code>)</li><li>更新阶段 (<code>Update</code>)</li><li>卸载阶段 (<code>Unmount</code>)</li></ul><h5 id="1-1、挂载阶段"><a href="#1-1、挂载阶段" class="headerlink" title="1.1、挂载阶段"></a>1.1、挂载阶段</h5><ul><li><p><strong><code>constructor()</code></strong></p><ul><li>挂载之前调用一次，可以初始化 <code>state</code>。</li></ul></li><li><p><strong><code>getDefaultProps()</code></strong></p><ul><li>设置默认的 <code>props</code> ，也可以用 <code>dufaultProps</code> 设置组件的默认属性。</li></ul></li><li><p><strong>getInitialState()</strong></p><ul><li>初始化 <code>state</code>，可以直接在 <code>constructor</code> 中定义 <code>this.state</code>（推荐方式）。</li></ul></li><li><p><strong>componentWillMount()</strong></p><ul><li><code>componentWillMount</code> 方法的调用在 <code>constructor</code> 之后，在 <code>render</code> 之前，在这方法里的代码调用 <code>setState</code> 方法不会触发重渲染，所以它一般不会用来作加载数据之用，它也很少被使用到（在 <code>React 16.9</code> 中也被废弃）；</li><li>这是服务端渲染（<code>server render</code>）中唯一调用的钩子（<code>hook</code>）。</li></ul></li><li><p><strong>render()</strong></p><ul><li><code>react</code> 中最重要的步骤，创建虚拟 <code>dom</code>、进行 <code>diff</code> 算法，更新 <code>dom</code> 树都在此进行；</li><li>在 <code>componentWillMount()</code> 方法之后执行；</li><li>在 <code>componentWillReceive(nextProps, nextState)</code> 方法之后执行。</li></ul></li><li><p><strong>componentDidMount()</strong></p><ul><li>这个方法会在 <code>render()</code> 之后立即执行。在这个时候之后组件已经生成了对应的 <code>DOM</code> 结构，可以通过 <code>this.getDOMNode()</code> 来进行访问；</li><li>这里可以加载服务器数据，并且如果使用了 <code>redux</code>，这里可以出发加载服务器数据的 <code>action</code>；</li><li>这里可以使用 <code>setState()</code> 方法触发重新渲染（<code>re-render</code>）。</li></ul></li></ul><blockquote><p>注：把 <code>Ajax</code> 请求放在 <code>componentWillMount</code> 函数中也是可以的，但是官方推荐放在 <code>componentDidMount</code> 这个生命周期函数中发起 <code>Ajax</code> 请求，因为执行这个生命周期时，<code>DOM</code> 已经挂载完了，这样做可以拿到 <code>Ajax</code> 请求返回的数据并通过 <code>setState</code> 来更新组件。</p></blockquote><h5 id="1-2、更新阶段"><a href="#1-2、更新阶段" class="headerlink" title="1.2、更新阶段"></a>1.2、更新阶段</h5><ul><li><p><strong>componentWillReceivePorps(nextProps)</strong></p><ul><li>在已经挂载的组件接收到一个新的 <code>prop</code> 时被执行。这个方法在初始化 <code>render</code> 时不会被调用；</li><li>如果你需要在 <code>props</code> 发生变化时来更新 <code>state</code>，你可能需要比较 <code>this.props</code> 和 <code>nextProps</code>，然后根据比较结果，使用 <code>this.setState()</code> 方法来改变 <code>this.state</code>；</li></ul></li><li><p><strong>shouldComponentUpdate(nextProps, nextState)</strong></p><ul><li>组件接收到新的 <code>props</code> 或者 <code>state</code> 发生改变时被调用，在初始化时或者使用 <code>forceUpdate</code> 时不被执行；</li><li><code>return true</code> 就会更新 <code>dom</code>（使用 <code>diff</code> 算法更新），<code>return false</code> 能阻止更新（不调用 <code>render</code>）；</li><li>可以在你确认不需要更新组件时使用，提升性能。</li></ul></li><li><p><strong>componentWillUpdate(nextProps, nextState)</strong></p><ul><li>组件挂载时不调用，只有在组件将要更新时才调用。也就是说：在 <code>props</code> 或 <code>state</code> 发生改变或者 <code>shouldComponentUpdate(nextProps, nextState)</code> 触发后，在 <code>render()</code> 之前执行；</li><li>要特别注意，<code>componentWillUpdate</code> 生命周期钩子每次更新前都会执行，所以在这里调用 <code>this.setState</code> 非常危险，有可能会没完没了。</li></ul></li><li><p><strong>render()</strong></p><ul><li><code>react</code> 中最重要的步骤，创建虚拟 <code>dom</code>、进行 <code>diff</code> 算法，更新 <code>dom</code> 树都在此进行；</li><li>在 <code>componentWillMount()</code> 方法之后执行；</li><li>在 <code>componentWillReceive(nextProps, nextState)</code> 方法之后执行。</li></ul></li><li><p><strong>componentDidUpdate(nextProps, nextState, snapshot)</strong></p><ul><li>这是组件更新或者发生 <code>componentWillUpdate(nextProps, nextState)</code> 之后触发的生命周期钩子；</li><li>使用这个方法可以对组件中的 <code>DOM</code> 进行操作；</li><li>如果 <code>shouldComponentUpdate(nextProps, nextState)</code> 返回 <code>false</code>，那么 <code>componentDidUpdate(prevProps, prevState)</code> 不会被触发；</li><li>因为 <code>componentDidUpdate</code> 生命周期钩子每次更新后都会被执行，所以在这里调用 <code>this.setState</code> 也非常危险，有可能会没完没了；</li><li>搭配 <code>getSnapshotBeforeUpdate</code> 生命周期钩子（<code>React 16</code> 中的新生命周期）使用的时候，第三个参数是 <code>getSnapshotBeforeUpdate</code> 的返回值。</li></ul></li></ul><h5 id="1-3、卸载阶段"><a href="#1-3、卸载阶段" class="headerlink" title="1.3、卸载阶段"></a>1.3、卸载阶段</h5><ul><li><p><strong>componentWillUnmount()</strong></p><ul><li><p>组件渲染之后，卸载或销毁之前的生命周期钩子，只调用一次。</p></li><li><p><code>React</code> 的最佳实践是，组件中用到的事件监听器、订阅器、定时器都要在这里销毁。事件监听指的是下面这种情况：</p><pre class="language-jsx"><code class="language-jsx"><span class="token function">componentDidMount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  document<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'click'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></li><li><p>下面这种事件绑定， <code>React</code> 会自动销毁：</p><pre class="language-jsx"><code class="language-jsx"><span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">onClick</span><span class="token script language-javascript"><span class="token punctuation">=</span><span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>handleClick<span class="token punctuation">}</span></span><span class="token punctuation">></span></span>click<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">></span></span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></li></ul></li></ul><p>下面我们再看看新的生命周期。</p><h4 id="2、新的生命周期"><a href="#2、新的生命周期" class="headerlink" title="2、新的生命周期"></a>2、新的生命周期</h4><p>再来看下 <code>React v16.4</code> 的生命周期图：</p><p><img src="https://raw.githubusercontent.com/IDeepspace/ImageHosting/master/React/reactv16.4-lifecycle.jpg" alt="Reactv16.4生命周期图"></p><p></p><p align="center">(图片来自网络)</p><br><code>React16</code> 废弃的三个生命周期函数：<p></p><ul><li><code>componentWillMount</code></li><li><code>componentWillReceiveProps</code></li><li><code>componentWillUpdate</code></li></ul><p>目前在 <code>React 16</code> 版本中，官方并未完全删除这三个函数，而且新增了：</p><ul><li><code>UNSAFE_componentWillMount</code>，</li><li><code>UNSAFE_componentWillReceiveProps</code>，</li><li><code>UNSAFE_componentWillUpdate</code></li></ul><p>这三个函数，计划在 <code>React 17</code> 的版本（更新，已经在 <code>React 16.9</code> 中被废弃）中移除掉这三个函数，目的是为了做向下兼容。</p><p>那为什么会移除这三个生命周期函数呢？</p><h5 id="2-1、废除-componentWillMount"><a href="#2-1、废除-componentWillMount" class="headerlink" title="2.1、废除 componentWillMount"></a>2.1、废除 componentWillMount</h5><p>很多人会有一个误区：这个钩子是请求数据然后将数据插入元素一同挂载的最佳时机。</p><p>其实 <code>componentWillMount</code> 和挂载（<code>render</code>）是同步执行的，意味着执行完这个钩子，立即挂载。而向服务器请求数据是异步执行的。所以无论请求多么快，都要排在同步任务之后再处理。也就是说，永远不可能在这里将数据插入元素一同挂载。并不是说不能在这里请求数据，而是达不到你臆想的效果。</p><p>它被废弃的原因主要有：</p><ul><li>如果它声明了定时器或者订阅器，在服务端渲染中，<code>componentWillUnmount</code> 生命周期钩子中的清除代码不会生效。因为如果组件没有挂载成功，<code>componentWillUnmount</code> 是不会执行的。没有挂载就没有卸载。</li><li>在异步渲染中，它的表现不稳定。</li><li>初始化 <code>this.state</code> 应该在 <code>constructor</code> 生命周期钩子中完成，请求数据应该在 <code>componentDidMount</code> 生命周期钩子中完成，所以本来它就没什么用。可能当初创造它是为了成双成对吧，所以才被完全废弃了。</li></ul><h5 id="2-2、废除-componentWillReceiveProps"><a href="#2-2、废除-componentWillReceiveProps" class="headerlink" title="2.2、废除 componentWillReceiveProps"></a>2.2、废除 componentWillReceiveProps</h5><p><code>componentWillReceiveProps</code> 生命周期钩子只有一个参数，更新后的 <code>props</code>。</p><p>该声明周期函数可能在两种情况下被触发：</p><ul><li>组件接收到了新的属性。</li><li>组件没有收到新的属性，但是由于父组件重新渲染导致当前组件也被重新渲染。</li></ul><p>初始化时并不会触发该生命周期钩子。</p><p>因为 <code>Fiber</code> 机制的引入，这个生命周期钩子有可能会多次触发。</p><h5 id="2-3、componentWillUpdate"><a href="#2-3、componentWillUpdate" class="headerlink" title="2.3、componentWillUpdate"></a>2.3、componentWillUpdate</h5><p><code>shouldComponentUpdate</code> 生命周期钩子返回 <code>true</code>，或者调用 <code>this.forceUpdate</code> 之后，会立即执行该生命周期钩子。</p><p>要特别注意，<code>componentWillUpdate</code> 生命周期钩子每次更新前都会执行，所以在这里调用 <code>this.setState</code> 非常危险，有可能会没完没了。</p><p>同样，因为 <code>Fiber</code> 机制的引入，这个生命周期钩子有可能会多次调用。</p><p>新增加了两个新的生命周期函数</p><ul><li><code>static getDerivedStateFromProps</code></li><li><code>getSnapshotBeforeUpdate</code></li></ul><h5 id="2-4、新增-getDerivedStateFromProps"><a href="#2-4、新增-getDerivedStateFromProps" class="headerlink" title="2.4、新增 getDerivedStateFromProps"></a>2.4、新增 getDerivedStateFromProps</h5><p><code>static getDerivedStateFromProps(nextProps, prevState)</code>，它是一个静态方法，所以不能再这个函数里面使用 <code>this</code>。</p><p>这个函数有两个参数： <code>props</code> 和 <code>state</code>，分别指接收到的新参数和当前的 <code>state</code> 对象。</p><p>该函数会返回一个对象用来更新当前的 <code>state</code> 对象，如果不需要更新状态可以返回 <code>null</code> 来表明不需要更新任何状态。</p><p>该函数会在挂载时，接收到新的 <code>props</code>，调用了 <code>setState</code> 和 <code>forceUpdate</code> 时被调用，简单点说就是：<strong><code>getDerivedStateFromProps</code> 无论是在挂载阶段还是更新阶段，也无论是什么引起的更新，统统都会被调用，在首次渲染的时候也会被触发</strong> (注意：<code>v16.3</code> 中，<code>setState</code> 时、<code>forceUpdate</code> 时不会执行这个方法，<code>v16.4</code> 修复了这个问题)。</p><p>和 <code>componentWillReceiveProps</code> 不同，<code>getDerivedStateFromProps</code> 只在由父组件引起的更新时才会触发。</p><p>一个简单的例子：</p><pre class="language-jsx"><code class="language-jsx"><span class="token keyword">import</span> React<span class="token punctuation">,</span> <span class="token punctuation">{</span> Component <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'react'</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">A</span> <span class="token keyword">extends</span> <span class="token class-name">Component</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">super</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">=</span> <span class="token punctuation">{</span>
      name<span class="token punctuation">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">.</span>name<span class="token punctuation">,</span>
      counter<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment" spellcheck="true">// componentWillReceiveProps(nextProps) {</span>
  <span class="token comment" spellcheck="true">//   console.log('Running A.componentWillReceiveProps()');</span>
  <span class="token comment" spellcheck="true">// }</span>

  <span class="token keyword">static</span> <span class="token function">getDerivedStateFromProps</span><span class="token punctuation">(</span>nextProps<span class="token punctuation">,</span> prevState<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Being called'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>nextProps<span class="token punctuation">.</span>name <span class="token operator">!==</span> prevState<span class="token punctuation">.</span>name<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Running A.getDerivedStateFromProps()'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token punctuation">{</span>
        name<span class="token punctuation">:</span> nextProps<span class="token punctuation">.</span>name<span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  handleClick <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> <span class="token punctuation">{</span> counter <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      counter<span class="token punctuation">:</span> counter<span class="token operator">++</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'A.render()'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">></span></span>Hello <span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>name<span class="token punctuation">}</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">onClick</span><span class="token script language-javascript"><span class="token punctuation">=</span><span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>handleClick<span class="token punctuation">}</span></span><span class="token punctuation">></span></span><span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>counter<span class="token punctuation">}</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name">B</span> <span class="token keyword">extends</span> <span class="token class-name">Component</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">=</span> <span class="token punctuation">{</span> counter<span class="token punctuation">:</span> <span class="token number">0</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>A</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">'</span>World<span class="token punctuation">'</span></span> <span class="token punctuation">/></span></span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">componentDidMount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">setInterval</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        counter<span class="token punctuation">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>counter <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> B<span class="token punctuation">;</span>
</code></pre><p><code>getDerivedStateFromProps</code> 是用来替代 <code>componentWillReceiveProps</code> 的，应对 <code>state</code> 需要关联 <code>props</code> 变化的场景。它的作用就是让组件根据父组件传来的 <code>props</code>，判断是否需要更新自己的 <code>state</code> ，这种 <code>state</code> 叫做衍生 <code>state</code>。返回的对象就是要增量更新的<code>state</code>。</p><p>将 <code>getDerivedStateFromProps</code> 设计成静态函数，目的是保持该方法的纯粹，它就是用来定义衍生 <code>state</code> 的，能做的操作局限在根据 <code>props</code> 和 <code>state</code> 决定新的 <code>state</code>，除此之外不应该在里面执行任何操作。</p><p>一般使用场景如下：</p><ol><li>无条件的根据 <code>props</code> 更新 <code>state</code></li><li>当 <code>props</code> 和 <code>state</code> 的不匹配情况更新 <code>state</code></li></ol><h5 id="2-5、新增-getSnapshotBeforeUpdate"><a href="#2-5、新增-getSnapshotBeforeUpdate" class="headerlink" title="2.5、新增 getSnapshotBeforeUpdate"></a>2.5、新增 getSnapshotBeforeUpdate</h5><p>顾名思义，保存状态快照用的。</p><p>它会在组件即将挂载时调用，注意，是即将挂载。它甚至调用的比 <code>render</code> 还晚，由此可见 <code>render</code> 并没有完成挂载操作，而是进行构建抽象 <code>UI</code> 的工作。<code>getSnapshotBeforeUpdate</code> 执行完就会立即调用 <code>componentDidUpdate</code> 生命周期钩子。</p><p>它是做什么用的呢？有一些状态，比如网页滚动位置，不需要它持久化，只需要在组件更新以后能够恢复原来的位置即可。</p><p><code>getSnapshotBeforeUpdate</code> 生命周期钩子返回的值会被 <code>componentDidUpdate</code> 的第三个参数接收，我们可以利用这个通道保存一些不需要持久化的状态，用完即可舍弃。</p><p>很显然，它是用来取代 <code>componentWillUpdate</code> 生命周期钩子的。</p><p>意思就是说呀，开发者一般用不到它。</p><h3 id="六、最后"><a href="#六、最后" class="headerlink" title="六、最后"></a>六、最后</h3><p>本篇内容代码：<a href="https://github.com/IDeepspace/React-Workshop/tree/master/react-16-api" target="_blank" rel="noopener">https://github.com/IDeepspace/React-Workshop/tree/master/react-16-api</a></p></div><hr><style>#reward{margin:40px 0;text-align:center}#reward .reward-link{font-size:1.88rem}#reward .btn-floating:hover{box-shadow:0 6px 12px rgba(0,0,0,.2),0 5px 15px rgba(0,0,0,.2)}#rewardModal{width:320px;height:350px}#rewardModal .reward-title{margin:15px auto;padding-bottom:5px}#rewardModal .modal-content{padding:10px}#rewardModal .close{position:absolute;right:15px;top:15px;color:rgba(0,0,0,.5);font-size:1.3rem;line-height:20px;cursor:pointer}#rewardModal .reward-tabs{margin:0 auto;width:210px}.reward-tabs .tabs{height:38px;margin:10px auto;padding-left:0}.reward-tabs .tabs .tab{height:38px;line-height:38px}.reward-tabs .tab a{color:#fff;background-color:#ccc}.reward-tabs .tab a:hover{color:#fff}.reward-tabs .wechat-tab .active{color:#fff;background-color:#22ab38}.reward-tabs .alipay-tab .active{color:#fff;background-color:#019fe8}.reward-tabs .reward-img{width:210px;height:210px}</style><div id="reward"> <a class="reward-link btn-floating btn-large waves-effect waves-light red">赏</a><div id="rewardModal" class="modal"><div class="modal-content"><a class="close"><i class="fa fa-close"></i></a><h4 class="reward-title">请我喝杯咖啡?</h4><div class="reward-content"><div class="reward-tabs"><ul class="tabs"><li class="tab wechat-tab waves-effect waves-light"><a class="active" href="#wechat">微信</a></li><li class="tab alipay-tab waves-effect waves-light"><a href="#alipay">支付宝</a></li></ul><div id="wechat"> <img src="/medias/reward/wechat.png" class="reward-img" alt="微信打赏二维码"></div><div id="alipay"> <img src="/medias/reward/alipay.png" class="reward-img" alt="支付宝打赏二维码"></div></div></div></div></div></div><script>$(function(){$("#reward .reward-link").on("click",function(){$("#rewardModal").openModal()}),$("#rewardModal .close").on("click",function(){$("#rewardModal").closeModal()})})</script><link rel="stylesheet" type="text/css" href="/libs/share/css/share.min.css"><div id="article-share"><div class="social-share" data-disabled="qzone" data-wechat-qrcode-helper="<p>微信里点“发现”->“扫一扫”二维码便可查看分享。</p>"></div></div><script src="/libs/share/js/social-share.min.js"></script><div class="reprint"><p> <span class="reprint-tip">转载请注明:</span> <a href="https://togoblog.cn" class="b-link-green">Deepspace</a><i class="fa fa-angle-right fa-lg fa-fw text-color"></i> <a href="/react-new-api-in-16/" class="b-link-green">React 16 中的新特性</a></p></div></div></div><div class="article" data-aos="fade-up"><div class="card relate-article-wrapper"><header class="relate-article-header">相关文章&nbsp;<i class="fa fa-arrow-right"></i></header><div class="relate-post-box"><div class="relate-post"> <span>1、</span><a id="relate-post-link" href="/react-uncontrolled-and-controlled-components/">React 中的受控组件和非受控组件</a></div><div class="relate-post"> <span>2、</span><a id="relate-post-link" href="/react-high-order-component/">React 高阶组件</a></div><div class="relate-post"> <span>3、</span><a id="relate-post-link" href="/react-setstate/">React setState 的异步与同步</a></div><div class="relate-post"> <span>4、</span><a id="relate-post-link" href="/react-ref/">React 中的 Refs</a></div><div class="relate-post"> <span>5、</span><a id="relate-post-link" href="/react-virtual-dom-and-diff/">React 中的虚拟 DOM 和 diff 算法</a></div></div></div></div><div class="disqus-card card" data-aos="fade-up"><div id="disqus_thread" class="card-content"><noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript></div></div><script type="text/javascript">
    disqus_config = function () {
        this.page.url = 'https://togoblog.cn/react-new-api-in-16/';
        this.page.identifier = '/react-new-api-in-16/';
        this.page.title = 'React 16 中的新特性';
    };
    let disqus_shortname = 'https-togoblog-cn';

    (function () { // DON'T EDIT BELOW THIS LINE
        let d = document, s = d.createElement('script');
        // 如：s.src = 'https://Deepspace.disqus.com/embed.js';
        s.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script></div></div><div class="col l3 hide-on-med-and-down"><div class="toc-widget"><div class="toc-title">目录</div><div id="toc-content"></div></div></div></div><script src="/libs/tocbot/tocbot.min.js"></script><script>
    $(function () {
        tocbot.init({
            tocSelector: '#toc-content',
            contentSelector: '#articleContent',
            headingSelector: 'h2, h3, h4, h4'
        });

        // modify the toc link href to support Chinese.
        let i = 0;
        let tocHeading = 'toc-heading-';
        $('#toc-content a').each(function () {
            $(this).attr('href', '#' + tocHeading + (++i));
        });

        // modify the heading title id to support Chinese.
        i = 0;
        $('#articleContent').children('h2, h3, h4, h4').each(function () {
            $(this).attr('id', tocHeading + (++i));
        });

        // Set scroll toc fixed.
        let tocHeight = parseInt($(window).height() * 0.4 - 64);
        let $tocWidget = $('.toc-widget');
        $(window).scroll(function () {
            let scroll = $(window).scrollTop();
            /* add post toc fixed. */
            if (scroll > tocHeight) {
                $tocWidget.addClass('toc-fixed');
            } else {
                $tocWidget.removeClass('toc-fixed');
            }
        });
    });
</script></main><footer class="page-footer bg-color"><div class="container row center-align"><div class="col s12 m8 l8 copy-right"> <span>COPYRIGHT 2020 DEEPSPACE. ALL RIGHTS RESERVED.</span></div><div class="col s12 m4 l4 social-link"><a href="https://github.com/IDeepspace" class="tooltipped" target="_blank" data-tooltip="访问我的GitHub" data-position="top" data-delay="50"><i class="fa fa-github"></i></a><a href="mailto:cxin1427@qq.com" class="tooltipped" target="_blank" data-tooltip="邮件联系我" data-position="top" data-delay="50"><i class="fa fa-envelope-open"></i></a><a href="#!" class="tooltipped" data-tooltip="QQ: 690862036" data-position="top" data-delay="50"><i class="fa fa-qq"></i></a><a href="/atom.xml" class="tooltipped" target="_blank" data-tooltip="RSS 订阅" data-position="top" data-delay="50"><i class="fa fa-rss"></i></a></div></div></footer><div class="progress-bar"></div><div id="searchModal" class="modal"><div class="modal-content"><div class="search-header"> <span class="title">搜索</span> <input type="search" id="searchInput" name="s" placeholder="请输入搜索的关键字" class="search-input" autofocus></div><div id="searchResult"></div></div></div><script src="/js/search.js"></script><script type="text/javascript">searchFunc("/search.xml","searchInput","searchResult")</script><div id="backTop" class="top-scroll"><a class="btn-floating btn-large waves-effect waves-light" href="#!"><i class="fa fa-angle-up"></i></a></div><script src="/libs/materialize/js/materialize.min.js"></script><script src="/libs/masonry/masonry.pkgd.min.js"></script><script src="/libs/aos/aos.js"></script><script src="/libs/scrollprogress/scrollProgress.min.js"></script><script src="/libs/lightGallery/js/lightgallery-all.min.js"></script><script src="/js/matery.js"></script></body></html>