<!DOCTYPE HTML><html lang="zh-CN"><head><head><meta name="generator" content="Hexo 3.8.0"><meta charset="utf-8"><meta name="keywords" content="React 中的虚拟 DOM 和 diff 算法, Deepspace"><meta name="description" content="React 中的虚拟 DOM 和 diff 算法本篇内容将会探究 React 中的虚拟 DOM 和 diff 算法，明白大致原理，并了解如何简单实现 虚拟 DOM 树。
一、真实的 DOM为什么需要虚拟 DOM（Virtual DOM）呢？"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><meta name="renderer" content="webkit|ie-stand|ie-comp"><meta name="mobile-web-app-capable" content="yes"><meta name="format-detection" content="telephone=no"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"><title>React 中的虚拟 DOM 和 diff 算法 | Deepspace</title><link rel="icon" type="image/png" href="/favicon.png"><link rel="stylesheet" type="text/css" href="/libs/awesome/css/font-awesome.min.css"><link rel="stylesheet" type="text/css" href="/libs/materialize/css/materialize.min.css"><link rel="stylesheet" type="text/css" href="/libs/aos/aos.css"><link rel="stylesheet" type="text/css" href="/libs/animate/animate.min.css"><link rel="stylesheet" type="text/css" href="/libs/lightGallery/css/lightgallery.min.css"><link rel="stylesheet" type="text/css" href="/css/matery.css"><link rel="stylesheet" type="text/css" href="/css/my.css"><script src="/libs/jquery/jquery-2.2.0.min.js"></script><link rel="stylesheet" href="/css/prism-tomorrow.css" type="text/css"></head></head><body><header class="navbar-fixed"><nav id="headNav" class="bg-color nav-transparent"><div id="navContainer" class="container"><div class="nav-wrapper"><div class="brand-logo"><a href="/" class="waves-effect waves-light"><span></span> <span class="logo-span">Deepspace</span></a></div><a href="#" data-activates="mobile-nav" class="button-collapse"><i class="fa fa-navicon"></i></a><ul class="right"><li class="hide-on-med-and-down"><a href="/" class="waves-effect waves-light"><i class="fa fa-home"></i> <span>首页</span></a></li><li class="hide-on-med-and-down"><a href="/tags" class="waves-effect waves-light"><i class="fa fa-tags"></i> <span>标签</span></a></li><li class="hide-on-med-and-down"><a href="/categories" class="waves-effect waves-light"><i class="fa fa-bookmark"></i> <span>分类</span></a></li><li class="hide-on-med-and-down"><a href="/archives" class="waves-effect waves-light"><i class="fa fa-archive"></i> <span>归档</span></a></li><li class="hide-on-med-and-down"><a href="/about" class="waves-effect waves-light"><i class="fa fa-user-circle-o"></i> <span>关于</span></a></li><li><a id="toggleSearch" class="waves-effect waves-light"><i id="searchIcon" class="mdi-action-search"></i></a></li></ul><div class="side-nav" id="mobile-nav"><div class="mobile-head bg-color"><div class="logo-name">Deepspace</div><div class="logo-desc"> 凡事预 ？立 ：废</div></div><ul class="menu-list mobile-menu-list"><li><a href="/" class="waves-effect waves-light"><i class="fa fa-fw fa-home"></i> 首页</a></li><li><a href="/tags" class="waves-effect waves-light"><i class="fa fa-fw fa-tags"></i> 标签</a></li><li><a href="/categories" class="waves-effect waves-light"><i class="fa fa-fw fa-bookmark"></i> 分类</a></li><li><a href="/archives" class="waves-effect waves-light"><i class="fa fa-fw fa-archive"></i> 归档</a></li><li><a href="/about" class="waves-effect waves-light"><i class="fa fa-fw fa-user-circle-o"></i> 关于</a></li><li><div class="divider"></div></li><li><a href="https://github.com/IDeepspace" class="waves-effect waves-light" target="_blank"><i class="fa fa-github-square fa-fw"></i> Fork Me</a></li></ul><div class="social-link"><a href="https://github.com/IDeepspace" class="tooltipped" target="_blank" data-tooltip="访问我的GitHub" data-position="top" data-delay="50"><i class="fa fa-github"></i></a><a href="mailto:cxin1427@qq.com" class="tooltipped" target="_blank" data-tooltip="邮件联系我" data-position="top" data-delay="50"><i class="fa fa-envelope-open"></i></a><a href="#!" class="tooltipped" data-tooltip="QQ: 690862036" data-position="top" data-delay="50"><i class="fa fa-qq"></i></a><a href="/atom.xml" class="tooltipped" target="_blank" data-tooltip="RSS 订阅" data-position="top" data-delay="50"><i class="fa fa-rss"></i></a></div></div></div></div><style>.nav-transparent .github-corner{display:none!important}.github-corner{position:absolute;z-index:10;top:0;right:0;border:0;transform:scale(1.1)}.github-corner svg{color:#202020;fill:#fff;height:64px;width:64px}.github-corner:hover .octo-arm{animation:a .56s ease-in-out}.github-corner .octo-arm{animation:none}@keyframes a{0%,to{transform:rotate(0)}20%,60%{transform:rotate(-25deg)}40%,80%{transform:rotate(10deg)}}</style> <a href="https://github.com/IDeepspace" class="github-corner tooltipped hide-on-med-and-down" target="_blank" data-tooltip="Fork Me" data-position="left" data-delay="50"><svg viewbox="0 0 250 250" aria-hidden="true"><path d="M0 0 115 115 130 115 142 142 250 250 250 0Z"/><path d="M128.3 109C113.8 99.7 119 89.6 119 89.6 122 82.7 120.5 78.6 120.5 78.6 119.2 72 123.4 76.3 123.4 76.3 127.3 80.9 125.5 87.3 125.5 87.3 122.9 97.6 130.6 101.9 134.4 103.2" fill="currentColor" style="transform-origin:130px 106px" class="octo-arm"/><path d="M115 115C114.9 115.1 118.7 116.5 119.8 115.4L133.7 101.6C136.9 99.2 139.9 98.4 142.2 98.6 133.8 88 127.5 74.4 143.8 58 148.5 53.4 154 51.2 159.7 51 160.3 49.4 163.2 43.6 171.4 40.1 171.4 40.1 176.1 42.5 178.8 56.2 183.1 58.6 187.2 61.8 190.9 65.4 194.5 69 197.7 73.2 200.1 77.6 213.8 80.2 216.3 84.9 216.3 84.9 212.7 93.1 206.9 96 205.4 96.6 205.1 102.4 203 107.8 198.3 112.5 181.9 128.9 168.3 122.5 157.7 114.1 157.9 116.9 156.7 120.9 152.7 124.9L141 136.5C139.8 137.7 141.6 141.9 141.8 141.8Z" fill="currentColor" class="octo-body"/></svg></a></nav></header><div class="bg-cover post-cover" style="background-image:url(/medias/featureimages/lighted.jpg)"><div class="container"><div class="row"><div class="col s12 m12 l12"><div class="brand"><div class="description center-align post-detail-title"> React 中的虚拟 DOM 和 diff 算法</div></div></div></div></div></div><main class="post-container content"><link rel="stylesheet" href="/libs/tocbot/tocbot.css"><style>#articleContent h1,#articleContent h2,#articleContent h3,#articleContent h4,#articleContent h5,#articleContent h6{padding-top:76px;margin-top:-76px}#articleContent h1{line-height:3.5rem}#articleContent h2{line-height:3.2rem}#articleContent h3{line-height:2.8rem}#articleContent h4{line-height:2.5rem}#articleContent h5{line-height:2.2rem}#articleContent h6{line-height:1.9rem}#articleContent :focus{outline:0}.toc-fixed{position:fixed;top:64px}.toc-widget{padding-left:20px}.toc-widget .toc-title{margin:35px 0 15px 0;padding-left:17px;font-size:1.5rem;font-weight:700;line-height:1.5rem}.toc-widget ol{padding:0;list-style:none}#toc-content ol{padding-left:10px}#toc-content ol li{padding-left:10px}#toc-content .toc-link:hover{color:#42b983;font-weight:700;text-decoration:underline}#toc-content .toc-link::before{background-color:transparent;max-height:25px}#toc-content .is-active-link{color:#42b983}#toc-content .is-active-link::before{background-color:#42b983}</style><div class="row"><div class="col s12 m12 l9"><div id="artDetail"><div class="card"><div class="card-content article-info"><div class="article-tag"> <a href="/tags/React/" target="_blank"><span class="chip bg-color">React</span></a></div><div class="post-info"><span class="post-cate"><i class="fa fa-bookmark fa-fw icon-category"></i> <a href="/categories/React/" class="post-category" target="_blank">React</a></span><span class="post-date"><i class="fa fa-clock-o fa-fw"></i> 2017-08-12</span></div></div><hr><div class="card-content article-card-content"><div id="articleContent"><h2 id="React-中的虚拟-DOM-和-diff-算法"><a href="#React-中的虚拟-DOM-和-diff-算法" class="headerlink" title="React 中的虚拟 DOM 和 diff 算法"></a>React 中的虚拟 DOM 和 diff 算法</h2><p>本篇内容将会探究 <code>React</code> 中的虚拟 <code>DOM</code> 和 <code>diff</code> 算法，明白大致原理，并了解如何简单实现 虚拟 <code>DOM</code> 树。</p><h3 id="一、真实的-DOM"><a href="#一、真实的-DOM" class="headerlink" title="一、真实的 DOM"></a>一、真实的 DOM</h3><p>为什么需要虚拟 <code>DOM</code>（<code>Virtual DOM</code>）呢？我们先来看看真实的 <code>DOM</code> 的问题。</p><p>假设页面上有一个列表，我们一般会这样写：</p><pre class="language-html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ul</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">'</span>list<span class="token punctuation">'</span></span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">'</span>item<span class="token punctuation">'</span></span><span class="token punctuation">></span></span>1<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">'</span>item<span class="token punctuation">'</span></span><span class="token punctuation">></span></span>2<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">'</span>item<span class="token punctuation">'</span></span><span class="token punctuation">></span></span>3<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ul</span><span class="token punctuation">></span></span>
</code></pre><p>列表中的数据依次是 <code>1</code>，<code>2</code>，<code>3</code>。现在需要把数据替换成 <code>4</code>、<code>5</code>、<code>6</code>、<code>7</code>，如果不使用 <code>React</code>，直接使用原生的操作 <code>DOM</code> 的 <code>API</code>，应该怎么操作？一般会有三种做法：</p><ol><li>使用 <code>removeChild()</code> 清空列表，再使用 <code>appendChild()</code> 添加 4 个元素；</li><li>针对前 3 个元素使用 <code>nodeValue</code> / <code>textContent</code> 修改，然后使用 <code>appendChild()</code> 添加 1 个元素；</li><li>使用 <code>innerHtml</code> 直接对整个列表做覆盖式操作。</li></ol><p>这三种不同的方式在性能上是会存在差异的。我们知道，<strong>由于<a href="https://togoblog.cn/reflow-and-repaint/">重排和重绘</a>的问题，当页面变得复杂的时候，频繁地操作 <code>DOM</code> 会造成很大的性能开销</strong>。所以，如果使用原生 <code>DOM API</code>，应当根据当前环境选用合适的 <code>DOM</code> 操作方式，小心翼翼，尽可能减少重排和重绘，但这无疑也<strong>增加了开发的复杂度</strong>，<strong>不利于工程师专注实现当前业务</strong>。</p><p>同时，真实的 <code>DOM</code> 上的属性是非常多的，一个简单的 <code>div</code> 上绑定的属性也很复杂：</p><pre class="language-javascript"><code class="language-javascript"><span class="token keyword">var</span> div <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'div'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> str <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">;</span>
<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> key <span class="token keyword">in</span> div<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  str <span class="token operator">=</span> str <span class="token operator">+</span><span class="token operator">=</span> key <span class="token operator">+</span> <span class="token string">' '</span>
<span class="token punctuation">}</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><p>可以在浏览器中查看打印结果。在 <code>div</code> 这个元素上，会<strong>默认挂载大量的属性和方法</strong>（这没办法改变，因为标准就是这么设计的），但是很多时候，我们其实并不关心也不会使用到这些内容。</p><h3 id="二、什么是虚拟-DOM？"><a href="#二、什么是虚拟-DOM？" class="headerlink" title="二、什么是虚拟 DOM？"></a>二、什么是虚拟 DOM？</h3><p>所以，浏览器处理 <code>DOM</code> 很慢，但是浏览器处理 <code>JavaScript</code> 很快。</p><p>上面的例子中的 <code>DOM</code> 结构可以使用下面这样的 <code>JavaScript</code> 对象来表示：</p><pre class="language-javascript"><code class="language-javascript"><span class="token keyword">const</span> VitrualDOM <span class="token operator">=</span> <span class="token punctuation">{</span>
  tagName<span class="token punctuation">:</span> <span class="token string">'ul'</span><span class="token punctuation">,</span> <span class="token comment" spellcheck="true">// 节点标签名</span>
  props<span class="token punctuation">:</span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">// DOM的属性，用一个对象存储键值对</span>
    id<span class="token punctuation">:</span> <span class="token string">'list'</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  children<span class="token punctuation">:</span> <span class="token punctuation">[</span> <span class="token comment" spellcheck="true">// 该节点的子节点</span>
    <span class="token punctuation">{</span> tagName<span class="token punctuation">:</span> <span class="token string">'li'</span><span class="token punctuation">,</span> props<span class="token punctuation">:</span> <span class="token punctuation">{</span> <span class="token keyword">class</span><span class="token punctuation">:</span> <span class="token string">'item'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> children<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'1'</span><span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span> tagName<span class="token punctuation">:</span> <span class="token string">'li'</span><span class="token punctuation">,</span> props<span class="token punctuation">:</span> <span class="token punctuation">{</span> <span class="token keyword">class</span><span class="token punctuation">:</span> <span class="token string">'item'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> children<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'2'</span><span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span> tagName<span class="token punctuation">:</span> <span class="token string">'li'</span><span class="token punctuation">,</span> props<span class="token punctuation">:</span> <span class="token punctuation">{</span> <span class="token keyword">class</span><span class="token punctuation">:</span> <span class="token string">'item'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> children<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'3'</span><span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><p>如上所示，我们使用了一个 <code>JavaScript</code> 对象可以很容易地将 <code>DOM</code> 结构表示出来，这个对象中有三个属性:</p><ol><li><code>tagName</code>：用来表示这个元素的标签名；</li><li><code>props</code>： 用来表示这个元素所包含的属性；</li><li><code>children</code>：用来表示这个元素的 <code>children</code>。</li></ol><blockquote><p>虚拟 <code>DOM</code> 里每一个 <code>Element</code> 实际上只有几个最重要的、最为有用的属性，并且没有那么多乱七八糟的引用，比如一些注册的属性和函数，所以哪怕是直接把虚拟 <code>DOM</code> 删了<strong>，</strong>根据新传进来的数据重新创建一个新的虚拟 <code>DOM</code> 也是非常快的。</p></blockquote><p>然后给节点实现渲染方法，就可以实现虚拟节点到真是 <code>DOM</code> 的转化，将 <code>VitrualDOM</code> 对象渲染成真实 <code>DOM</code>。这就是虚拟 <code>DOM</code> 的概念。</p><h3 id="三、diff-算法是什么？"><a href="#三、diff-算法是什么？" class="headerlink" title="三、diff 算法是什么？"></a>三、diff 算法是什么？</h3><p>使用虚拟 <code>DOM</code> 之后，我们只需要告诉 <code>React</code> 当前的视图处于什么状态，<code>React</code> 则会通过虚拟 <code>DOM</code> 的转化来确保真实的 <code>DOM</code> 与该状态相匹配。那该怎么处理状态的变化呢？</p><p><code>React</code> 是这样做的：</p><ol><li>用 <code>JavaScript</code> 对象来表示 <code>DOM</code> 树的结构，然后用这个虚拟 <code>DOM</code> 树构建一个真正的 <code>DOM</code> 树<strong>，</strong>插入到文档中；</li><li>当状态变更时，重新构建一个新的虚拟 <code>DOM</code> 树，然后用这个新的树和旧的树作对比，记录两个树的差异；</li><li>把差异应用在步骤一所构建的真正的 <code>DOM</code> 树上，视图就更新了。</li></ol><p>比较两颗 <code>DOM</code> 数的差异是 <code>Virtual DOM</code> 算法中最为核心的部分，这也就是 <code>diff</code> 算法。</p><p>在比较的过程中，只比较同级的节点，非同级的节点不在比较范围内，这样既可以满足更新视图的需求，又可以简化算法实现，这样算法复杂度就可以达到 <code>O(n)</code>。</p><p><img src="https://raw.githubusercontent.com/IDeepspace/ImageHosting/master/React/react-diff-1.png" alt="diff 算法" style="zoom:75%"></p><p align="center">（图片来自网络）</p><p>比较新旧两棵树的差异时，首先会对树进行遍历。常用的有两种遍历算法，分别是深度优先遍历和广度优先遍历。一般的 <code>diff</code> 算法中都采用的是<strong>深度优先遍历</strong>。<strong>对新旧两棵树进行一次深度优先的遍历，这样每个节点就都会有一个唯一的标记。</strong></p><p><img src="https://raw.githubusercontent.com/IDeepspace/ImageHosting/master/React/react-diff-2.png" alt="diff 算法" style="zoom:75%"></p><p align="center">（图片来自网络）</p><p>在遍历的时候，每遍历到一个节点就把该节点和新的树的同一个位置的节点进行对比，如果有差异的话就记录到一个对象里面。</p><p>在这个差异对象中记录了有改变的节点，常见的差异包括四种，分别是：</p><ul><li>替换节点</li><li>增加/删除子节点</li><li>修改节点属性</li><li>改变文本内容</li></ul><p>所以在记录差异的时候要根据不同的差异类型，记录不同的内容。</p><p>得到差异之后，就可以根据这些差异的不同类型，对 <code>DOM</code> 进行针对性的更新。与四种差异类型相对应的，是更新视图时具体的更新方法，分别是：</p><ul><li><code>replaceChild()</code></li><li><code>appendChild()</code> / <code>removeChild()</code></li><li><code>setAttribute()</code> / <code>removeAttribute()</code></li><li><code>textContent</code></li></ul><h3 id="四、虚拟-DOM-真的更快吗？"><a href="#四、虚拟-DOM-真的更快吗？" class="headerlink" title="四、虚拟 DOM 真的更快吗？"></a>四、虚拟 DOM 真的更快吗？</h3><p>虚拟 <code>DOM</code> 可以提升性能，这个说法是不那么准确的。直接操作 <code>DOM</code> 是非常耗费性能的，这一点毋庸置疑。但是 <code>React</code> 使用虚拟 <code>DOM</code> 也是无法避免操作 <code>DOM</code> 的。</p><p>虚拟 <code>DOM</code> 的优势在于 <code>React</code> 的 <code>diff</code> 算法和批处理策略。<code>React</code> 在页面更新之前，把所有的 <code>DOM</code> 操作搜集起来，一次性提交给真实的 <code>DOM</code>，这样可以尽量减少对慢速 <code>DOM</code> 的调用。</p><blockquote><p>实际上，这个计算过程我们在直接操作 <code>DOM</code>时，也是可以自己判断和实现的，但是一定会耗费非常多的精力和时间，而且往往我们自己做的是不如 <code>React</code> 好的。所以，在这个过程中 <code>React</code> 帮助我们”提升了性能”。</p></blockquote><p>但是，使用虚拟 <code>DOM</code> 时，首次渲染 <code>DOM</code> 时候由于多了一层虚拟 <code>DOM</code> 计算，所以可能比 <code>html</code> 渲染慢。</p><h3 id="五、如何简单实现虚拟-DOM-树？"><a href="#五、如何简单实现虚拟-DOM-树？" class="headerlink" title="五、如何简单实现虚拟 DOM 树？"></a>五、如何简单实现虚拟 DOM 树？</h3><p>有了前面的描述，下面我们来简单实现一个虚拟 <code>DOM</code>。有三个步骤：</p><ul><li><p>用 <code>JavaScript</code> 对象来表示 <code>DOM</code> 树的结构，然后用这个虚拟 <code>DOM</code> 树构建一个真正的 <code>DOM</code> 树<strong>，</strong>插入到文档中；</p></li><li><p>当状态变更时，重新构建一个新的虚拟 <code>DOM</code> 树，然后用这个新的树和旧的树作对比，记录两个树的差异；</p></li><li><p>把差异应用在步骤一所构建的真正的 <code>DOM</code> 树上，视图就更新了。</p></li></ul><h4 id="1、构建虚拟-DOM-树"><a href="#1、构建虚拟-DOM-树" class="headerlink" title="1、构建虚拟 DOM 树"></a>1、构建虚拟 DOM 树</h4><p>首先，我们要在内存中存储我们的 <code>DOM</code> 树，我们能够用纯 <code>JavaScript</code> 对象来表示它，假设我们有这样的一个结构：</p><pre class="language-html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ul</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>list<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span><span class="token punctuation">></span></span>item 1<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span><span class="token punctuation">></span></span>item 2<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ul</span><span class="token punctuation">></span></span>
</code></pre><p>我们可以这样来表示：</p><pre class="language-javascript"><code class="language-javascript"><span class="token punctuation">{</span>
  type<span class="token punctuation">:</span> <span class="token string">'ul'</span><span class="token punctuation">,</span>
  props<span class="token punctuation">:</span> <span class="token punctuation">{</span> <span class="token keyword">class</span><span class="token punctuation">:</span> <span class="token string">'list'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  children<span class="token punctuation">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span> type<span class="token punctuation">:</span> <span class="token string">'li'</span><span class="token punctuation">,</span> props<span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> children<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'item 1'</span><span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span> type<span class="token punctuation">:</span> <span class="token string">'li'</span><span class="token punctuation">,</span> props<span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> children<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'item 2'</span><span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre><p>我们可以写一个辅助函数：</p><pre class="language-javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">h</span><span class="token punctuation">(</span>type<span class="token punctuation">,</span> props<span class="token punctuation">,</span> <span class="token operator">...</span>children<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    type<span class="token punctuation">,</span>
    props<span class="token punctuation">,</span>
    children<span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><p>然后就可以像下面这样表示：</p><pre class="language-javascript"><code class="language-javascript"><span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'ul'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token keyword">class</span><span class="token punctuation">:</span> <span class="token string">'list'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'li'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">'item 1'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'li'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">'item 2'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><p>这样看起来清晰了很多，当 <code>h(...)</code> 执行之后，将会返回纯的 <code>JavaScript</code> 对象，即我们的虚拟 <code>DOM</code>。</p><p>如果你看过 <code>Babel JSX</code> 的<a href="https://babeljs.io/docs/plugins/transform-react-jsx/" target="_blank" rel="noopener">官方文档</a>，你就会知道，<code>Babel</code> 会把下面的代码：</p><pre class="language-html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ul</span> <span class="token attr-name">className</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>list<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span><span class="token punctuation">></span></span>item 1<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span><span class="token punctuation">></span></span>item 2<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ul</span><span class="token punctuation">></span></span>
</code></pre><p>编译成：</p><pre class="language-javascript"><code class="language-javascript">React<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'ul'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> className<span class="token punctuation">:</span> <span class="token string">'list'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  React<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'li'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">'item 1'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  React<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'li'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">'item 2'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span>
</code></pre><p>如果我们能够用我们的 <code>h(...)</code> 函数代替 <code>React.createElement(…)</code>，那么我们也能使用 <code>JSX</code> 语法了。其实，我们只需要在源文件头部加上这么一句注释：</p><pre class="language-javascript"><code class="language-javascript"><span class="token comment" spellcheck="true">/** @jsx h */</span>
</code></pre><p><code>Babel</code> 就会帮我们开始编译了。</p><h4 id="2、运用虚拟-DOM-构建真实的-DOM"><a href="#2、运用虚拟-DOM-构建真实的-DOM" class="headerlink" title="2、运用虚拟 DOM 构建真实的 DOM"></a>2、运用虚拟 DOM 构建真实的 DOM</h4><p>我们需要一个真实的 <code>DOM</code> 节点：</p><pre class="language-html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>root<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>
</code></pre><p>然后写一个 <code>createElement(…)</code> 函数把虚拟 <code>DOM</code> 转换成真实的 <code>DOM</code>：</p><pre class="language-javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">createElement</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> node <span class="token operator">===</span> <span class="token string">'string'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> document<span class="token punctuation">.</span><span class="token function">createTextNode</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">const</span> $el <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span>type<span class="token punctuation">)</span><span class="token punctuation">;</span>
  node
    <span class="token punctuation">.</span>children
    <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>createElement<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>$el<span class="token punctuation">.</span>appendChild<span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span>$el<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> $el<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><p>因为我们有两种类型的节点，<code>text</code> 和 <code>element</code>。因此 <code>createElement</code> 函数需要处理这两种情况。如果是 <code>element</code> 节点的话，需要递归地把它的子节点也构建起来。</p><p>现在完整的代码如下：</p><pre class="language-html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>root<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>
</code></pre><pre class="language-jsx"><code class="language-jsx"><span class="token comment" spellcheck="true">/** @jsx h */</span>

<span class="token keyword">function</span> <span class="token function">h</span><span class="token punctuation">(</span>type<span class="token punctuation">,</span> props<span class="token punctuation">,</span> <span class="token operator">...</span>children<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token punctuation">{</span> type<span class="token punctuation">,</span> props<span class="token punctuation">,</span> children <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">createElement</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> node <span class="token operator">===</span> <span class="token string">'string'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> document<span class="token punctuation">.</span><span class="token function">createTextNode</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">const</span> $el <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span>type<span class="token punctuation">)</span><span class="token punctuation">;</span>
  node
    <span class="token punctuation">.</span>children
    <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>createElement<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>$el<span class="token punctuation">.</span>appendChild<span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span>$el<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> $el<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> a <span class="token operator">=</span> <span class="token punctuation">(</span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ul</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">'</span>list<span class="token punctuation">'</span></span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span><span class="token punctuation">></span></span>item <span class="token number">1</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span><span class="token punctuation">></span></span>item <span class="token number">2</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ul</span><span class="token punctuation">></span></span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> $root <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'root'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
$root<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span><span class="token function">createElement</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><p>就像在 <code>React</code> 中，你仅仅只有一个 <code>root</code> 节点，其他所有的节点都将会在它里面。</p><h4 id="3、比较两棵虚拟-DOM-树的差异"><a href="#3、比较两棵虚拟-DOM-树的差异" class="headerlink" title="3、比较两棵虚拟 DOM 树的差异"></a>3、比较两棵虚拟 DOM 树的差异</h4><p><strong>节点变化</strong></p><pre class="language-javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">changed</span><span class="token punctuation">(</span>node1<span class="token punctuation">,</span> node2<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">typeof</span> node1 <span class="token operator">!==</span> <span class="token keyword">typeof</span> node2
    <span class="token operator">||</span> <span class="token keyword">typeof</span> node1 <span class="token operator">===</span> <span class="token string">'string'</span> <span class="token operator">&amp;&amp;</span> node1 <span class="token operator">!==</span> node2
    <span class="token operator">||</span> node1<span class="token punctuation">.</span>type <span class="token operator">!==</span> node2<span class="token punctuation">.</span>type<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><p><strong>更新节点，编写 <code>updateElement</code></strong></p><pre class="language-javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">updateElement</span><span class="token punctuation">(</span>$parent<span class="token punctuation">,</span> newNode<span class="token punctuation">,</span> oldNode<span class="token punctuation">,</span> index <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>oldNode<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    $parent<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>
      <span class="token function">createElement</span><span class="token punctuation">(</span>newNode<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>newNode<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    $parent<span class="token punctuation">.</span><span class="token function">removeChild</span><span class="token punctuation">(</span>
      $parent<span class="token punctuation">.</span>childNodes<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">changed</span><span class="token punctuation">(</span>newNode<span class="token punctuation">,</span> oldNode<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    $parent<span class="token punctuation">.</span><span class="token function">replaceChild</span><span class="token punctuation">(</span>
      <span class="token function">createElement</span><span class="token punctuation">(</span>newNode<span class="token punctuation">)</span><span class="token punctuation">,</span>
      $parent<span class="token punctuation">.</span>childNodes<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>newNode<span class="token punctuation">.</span>type<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> newLength <span class="token operator">=</span> newNode<span class="token punctuation">.</span>children<span class="token punctuation">.</span>length<span class="token punctuation">;</span>
    <span class="token keyword">const</span> oldLength <span class="token operator">=</span> oldNode<span class="token punctuation">.</span>children<span class="token punctuation">.</span>length<span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> newLength <span class="token operator">||</span> i <span class="token operator">&lt;</span> oldLength<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">updateElement</span><span class="token punctuation">(</span>
        $parent<span class="token punctuation">.</span>childNodes<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">,</span>
        newNode<span class="token punctuation">.</span>children<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span>
        oldNode<span class="token punctuation">.</span>children<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span>
        i<span class="token punctuation">,</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><p>打开开发人员工具，观察当你按下“重新加载”按钮时，可以看到应用的变化：</p><p><img src="https://raw.githubusercontent.com/IDeepspace/ImageHosting/master/React/react-diff-3.gif" alt="自己实现虚拟 DOM 树"></p><blockquote><p>实现的例子参考自完整代码：<a href="https://jsfiddle.net/cxin1427/cvdgtqup/" target="_blank" rel="noopener">https://jsfiddle.net/cxin1427/cvdgtqup/</a></p></blockquote><h3 id="六、扩展阅读"><a href="#六、扩展阅读" class="headerlink" title="六、扩展阅读"></a>六、扩展阅读</h3><p>以下几篇文章很不错，可以帮助我们更好地理解虚拟 <code>DOM</code> 和 <code>diff</code> 算法，推荐阅读。</p><ul><li><a href="https://www.infoq.cn/article/react-dom-diff" target="_blank" rel="noopener">https://www.infoq.cn/article/react-dom-diff</a></li><li><a href="https://segmentfault.com/a/1190000018891454" target="_blank" rel="noopener">https://segmentfault.com/a/1190000018891454</a></li><li><a href="https://juejin.im/post/5c0c7304f265da613e22106c" target="_blank" rel="noopener">https://juejin.im/post/5c0c7304f265da613e22106c</a></li><li><a href="https://github.com/livoras/blog/issues/13" target="_blank" rel="noopener">https://github.com/livoras/blog/issues/13</a></li></ul></div><hr><style>#reward{margin:40px 0;text-align:center}#reward .reward-link{font-size:1.88rem}#reward .btn-floating:hover{box-shadow:0 6px 12px rgba(0,0,0,.2),0 5px 15px rgba(0,0,0,.2)}#rewardModal{width:320px;height:350px}#rewardModal .reward-title{margin:15px auto;padding-bottom:5px}#rewardModal .modal-content{padding:10px}#rewardModal .close{position:absolute;right:15px;top:15px;color:rgba(0,0,0,.5);font-size:1.3rem;line-height:20px;cursor:pointer}#rewardModal .reward-tabs{margin:0 auto;width:210px}.reward-tabs .tabs{height:38px;margin:10px auto;padding-left:0}.reward-tabs .tabs .tab{height:38px;line-height:38px}.reward-tabs .tab a{color:#fff;background-color:#ccc}.reward-tabs .tab a:hover{color:#fff}.reward-tabs .wechat-tab .active{color:#fff;background-color:#22ab38}.reward-tabs .alipay-tab .active{color:#fff;background-color:#019fe8}.reward-tabs .reward-img{width:210px;height:210px}</style><div id="reward"> <a class="reward-link btn-floating btn-large waves-effect waves-light red">赏</a><div id="rewardModal" class="modal"><div class="modal-content"><a class="close"><i class="fa fa-close"></i></a><h4 class="reward-title">请我喝杯咖啡?</h4><div class="reward-content"><div class="reward-tabs"><ul class="tabs"><li class="tab wechat-tab waves-effect waves-light"><a class="active" href="#wechat">微信</a></li><li class="tab alipay-tab waves-effect waves-light"><a href="#alipay">支付宝</a></li></ul><div id="wechat"> <img src="/medias/reward/wechat.png" class="reward-img" alt="微信打赏二维码"></div><div id="alipay"> <img src="/medias/reward/alipay.png" class="reward-img" alt="支付宝打赏二维码"></div></div></div></div></div></div><script>$(function(){$("#reward .reward-link").on("click",function(){$("#rewardModal").openModal()}),$("#rewardModal .close").on("click",function(){$("#rewardModal").closeModal()})})</script><link rel="stylesheet" type="text/css" href="/libs/share/css/share.min.css"><div id="article-share"><div class="social-share" data-disabled="qzone" data-wechat-qrcode-helper="<p>微信里点“发现”->“扫一扫”二维码便可查看分享。</p>"></div></div><script src="/libs/share/js/social-share.min.js"></script><div class="reprint"><p> <span class="reprint-tip">转载请注明:</span> <a href="https://togoblog.cn" class="b-link-green">Deepspace</a><i class="fa fa-angle-right fa-lg fa-fw text-color"></i> <a href="/react-virtual-dom-and-diff/" class="b-link-green">React 中的虚拟 DOM 和 diff 算法</a></p></div></div></div><div class="article" data-aos="fade-up"><div class="card relate-article-wrapper"><header class="relate-article-header">相关文章&nbsp;<i class="fa fa-arrow-right"></i></header><div class="relate-post-box"><div class="relate-post"> <span>1、</span><a id="relate-post-link" href="/react-uncontrolled-and-controlled-components/">React 中的受控组件和非受控组件</a></div><div class="relate-post"> <span>2、</span><a id="relate-post-link" href="/react-high-order-component/">React 高阶组件</a></div><div class="relate-post"> <span>3、</span><a id="relate-post-link" href="/react-ref/">React 中的 Refs</a></div><div class="relate-post"> <span>4、</span><a id="relate-post-link" href="/react-setstate/">React setState 的异步与同步</a></div><div class="relate-post"> <span>5、</span><a id="relate-post-link" href="/react-hook/">React v16.8 Hook 功能</a></div></div></div></div><div class="disqus-card card" data-aos="fade-up"><div id="disqus_thread" class="card-content"><noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript></div></div><script type="text/javascript">
    disqus_config = function () {
        this.page.url = 'https://togoblog.cn/react-virtual-dom-and-diff/';
        this.page.identifier = '/react-virtual-dom-and-diff/';
        this.page.title = 'React 中的虚拟 DOM 和 diff 算法';
    };
    let disqus_shortname = 'https-togoblog-cn';

    (function () { // DON'T EDIT BELOW THIS LINE
        let d = document, s = d.createElement('script');
        // 如：s.src = 'https://Deepspace.disqus.com/embed.js';
        s.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script></div></div><div class="col l3 hide-on-med-and-down"><div class="toc-widget"><div class="toc-title">目录</div><div id="toc-content"></div></div></div></div><script src="/libs/tocbot/tocbot.min.js"></script><script>
    $(function () {
        tocbot.init({
            tocSelector: '#toc-content',
            contentSelector: '#articleContent',
            headingSelector: 'h2, h3, h4, h4'
        });

        // modify the toc link href to support Chinese.
        let i = 0;
        let tocHeading = 'toc-heading-';
        $('#toc-content a').each(function () {
            $(this).attr('href', '#' + tocHeading + (++i));
        });

        // modify the heading title id to support Chinese.
        i = 0;
        $('#articleContent').children('h2, h3, h4, h4').each(function () {
            $(this).attr('id', tocHeading + (++i));
        });

        // Set scroll toc fixed.
        let tocHeight = parseInt($(window).height() * 0.4 - 64);
        let $tocWidget = $('.toc-widget');
        $(window).scroll(function () {
            let scroll = $(window).scrollTop();
            /* add post toc fixed. */
            if (scroll > tocHeight) {
                $tocWidget.addClass('toc-fixed');
            } else {
                $tocWidget.removeClass('toc-fixed');
            }
        });
    });
</script></main><footer class="page-footer bg-color"><div class="container row center-align"><div class="col s12 m8 l8 copy-right"> <span>COPYRIGHT 2020 DEEPSPACE. ALL RIGHTS RESERVED.</span></div><div class="col s12 m4 l4 social-link"><a href="https://github.com/IDeepspace" class="tooltipped" target="_blank" data-tooltip="访问我的GitHub" data-position="top" data-delay="50"><i class="fa fa-github"></i></a><a href="mailto:cxin1427@qq.com" class="tooltipped" target="_blank" data-tooltip="邮件联系我" data-position="top" data-delay="50"><i class="fa fa-envelope-open"></i></a><a href="#!" class="tooltipped" data-tooltip="QQ: 690862036" data-position="top" data-delay="50"><i class="fa fa-qq"></i></a><a href="/atom.xml" class="tooltipped" target="_blank" data-tooltip="RSS 订阅" data-position="top" data-delay="50"><i class="fa fa-rss"></i></a></div></div></footer><div class="progress-bar"></div><div id="searchModal" class="modal"><div class="modal-content"><div class="search-header"> <span class="title">搜索</span> <input type="search" id="searchInput" name="s" placeholder="请输入搜索的关键字" class="search-input" autofocus></div><div id="searchResult"></div></div></div><script src="/js/search.js"></script><script type="text/javascript">searchFunc("/search.xml","searchInput","searchResult")</script><div id="backTop" class="top-scroll"><a class="btn-floating btn-large waves-effect waves-light" href="#!"><i class="fa fa-angle-up"></i></a></div><script src="/libs/materialize/js/materialize.min.js"></script><script src="/libs/masonry/masonry.pkgd.min.js"></script><script src="/libs/aos/aos.js"></script><script src="/libs/scrollprogress/scrollProgress.min.js"></script><script src="/libs/lightGallery/js/lightgallery-all.min.js"></script><script src="/js/matery.js"></script></body></html>